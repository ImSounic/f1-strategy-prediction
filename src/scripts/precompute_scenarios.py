"""
Pre-compute scenario analysis for all circuits -> export as TypeScript.

Usage:
    python -m src.scripts.precompute_scenarios
    python -m src.scripts.precompute_scenarios --circuit bahrain
    python -m src.scripts.precompute_scenarios --n-sims 300  (faster, less accurate)

Output:
    frontend/src/data/scenarios.ts
"""

import json
import logging
import re
from pathlib import Path

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s | %(levelname)-8s | %(message)s",
    datefmt="%H:%M:%S",
)
logger = logging.getLogger(__name__)

import argparse
import pandas as pd
import yaml

from src.simulation.scenario_engine import run_scenario_analysis


def load_config(config_path: str = "configs/config.yaml") -> dict:
    with open(config_path, "r") as f:
        return yaml.safe_load(f)


def clean_name(raw: str) -> str:
    name = re.sub(r'\s*\(\d+(?:/\d+)*\)\s*', '', raw)
    name = name.replace('MEDIUM', 'M').replace('HARD', 'H').replace('SOFT', 'S')
    return name.strip()


def format_compounds(seq: str) -> str:
    """'SOFT → MEDIUM → HARD' -> 'S→M→H'"""
    return seq.replace('SOFT', 'S').replace('MEDIUM', 'M').replace('HARD', 'H').replace(' ', '')


def generate_typescript(all_results: dict) -> str:
    """Convert scenario analysis results to TypeScript source."""
    lines = [
        "// Auto-generated by precompute_scenarios.py — do not edit manually",
        "",
        "export interface ScenarioStrategy {",
        "  rank: number",
        "  name: string",
        "  cleanName: string",
        "  compounds: string",
        "  stops: number",
        "  medianTime: number",
        "  delta: number",
        "  stdTime: number",
        "  scEvents: number",
        "}",
        "",
        "export interface DecisionTrigger {",
        "  scenarioId: string",
        "  scenarioName: string",
        "  icon: string",
        "  probability: number",
        "  trigger: string",
        "  action: string",
        "  actionStops: number",
        "  timeSaved: number",
        "  defaultRank: number",
        "}",
        "",
        "export interface ScenarioResult {",
        "  scenarioId: string",
        "  scenarioName: string",
        "  description: string",
        "  icon: string",
        "  probability: number",
        "  scenarioBest: string",
        "  scenarioBestStops: number",
        "  defaultPlanRank: number",
        "  timeDelta: number",
        "  strategies: ScenarioStrategy[]",
        "}",
        "",
        "export interface CircuitScenarios {",
        "  circuitKey: string",
        "  circuitName: string",
        "  season: number",
        "  scProbability: number",
        "  nSims: number",
        "  defaultPlan: {",
        "    name: string",
        "    cleanName: string",
        "    compounds: string",
        "    stops: number",
        "    medianTime: number",
        "  }",
        "  scenarios: ScenarioResult[]",
        "  triggers: DecisionTrigger[]",
        "}",
        "",
        "export const scenarioData: Record<string, CircuitScenarios> = {",
    ]
    
    for key, data in sorted(all_results.items()):
        dp = data["default_plan"]
        lines.append(f'  "{key}": {{')
        lines.append(f'    circuitKey: "{data["circuit_key"]}",')
        lines.append(f'    circuitName: "{data["circuit_name"]}",')
        lines.append(f'    season: {data["season"]},')
        lines.append(f'    scProbability: {data["sc_probability"]},')
        lines.append(f'    nSims: {data["n_sims_per_scenario"]},')
        lines.append(f'    defaultPlan: {{')
        lines.append(f'      name: "{dp["name"]}",')
        lines.append(f'      cleanName: "{dp["clean_name"]}",')
        lines.append(f'      compounds: "{format_compounds(dp["compound_sequence"])}",')
        lines.append(f'      stops: {dp["num_stops"]},')
        lines.append(f'      medianTime: {dp["median_time"]:.1f},')
        lines.append(f'    }},')
        
        # Scenarios
        lines.append(f'    scenarios: [')
        for sc in data["scenarios"]:
            lines.append(f'      {{')
            lines.append(f'        scenarioId: "{sc["scenario_id"]}",')
            lines.append(f'        scenarioName: "{sc["scenario_name"]}",')
            # Escape quotes in description
            desc = sc["description"].replace('"', '\\"')
            lines.append(f'        description: "{desc}",')
            lines.append(f'        icon: "{sc["icon"]}",')
            lines.append(f'        probability: {sc["probability"]},')
            lines.append(f'        scenarioBest: "{sc["scenario_best"]}",')
            lines.append(f'        scenarioBestStops: {sc["scenario_best_stops"]},')
            lines.append(f'        defaultPlanRank: {sc["default_plan_rank"]},')
            lines.append(f'        timeDelta: {sc["time_delta_vs_default"]},')
            lines.append(f'        strategies: [')
            
            for r in sc["rankings"][:6]:  # top 6 per scenario
                lines.append(f'          {{ rank: {r["rank"]}, name: "{r["strategy_name"]}", '
                             f'cleanName: "{r["clean_name"]}", '
                             f'compounds: "{format_compounds(r["compound_sequence"])}", '
                             f'stops: {r["num_stops"]}, '
                             f'medianTime: {r["median_time"]:.1f}, '
                             f'delta: {r["delta"]}, '
                             f'stdTime: {r["std_time"]:.1f}, '
                             f'scEvents: {r["mean_sc_events"]:.1f} }},')
            
            lines.append(f'        ],')
            lines.append(f'      }},')
        lines.append(f'    ],')
        
        # Triggers
        lines.append(f'    triggers: [')
        for t in data["decision_triggers"]:
            trigger_text = t["trigger"].replace('"', '\\"')
            lines.append(f'      {{ scenarioId: "{t["scenario_id"]}", '
                         f'scenarioName: "{t["scenario_name"]}", '
                         f'icon: "{t["icon"]}", '
                         f'probability: {t["probability"]}, '
                         f'trigger: "{trigger_text}", '
                         f'action: "{t["action"]}", '
                         f'actionStops: {t["action_stops"]}, '
                         f'timeSaved: {t["time_saved"]}, '
                         f'defaultRank: {t["default_rank"]} }},')
        lines.append(f'    ],')
        
        lines.append(f'  }},')
    
    lines.append("}")
    lines.append("")
    
    return "\n".join(lines)


def main():
    parser = argparse.ArgumentParser(description="Pre-compute scenario analysis")
    parser.add_argument("--circuit", type=str, help="Single circuit key")
    parser.add_argument("--season", type=int, default=2025)
    parser.add_argument("--n-sims", type=int, default=500)
    parser.add_argument("--config", type=str, default="configs/config.yaml")
    args = parser.parse_args()
    
    config = load_config(args.config)
    raw_paths = config["paths"]["raw"]
    circuit_csv = Path(raw_paths["supplementary"]) / "pirelli_circuit_characteristics.csv"
    
    if args.circuit:
        circuit_keys = [args.circuit]
    else:
        circuits_df = pd.read_csv(circuit_csv)
        circuit_keys = sorted(
            circuits_df[circuits_df["season"] == args.season]["circuit_key"].unique()
        )
    
    logger.info(f"Pre-computing scenarios for {len(circuit_keys)} circuits...")
    
    all_results = {}
    for key in circuit_keys:
        try:
            result = run_scenario_analysis(key, args.season, args.n_sims, args.config)
            ts_key = f"{key}_{args.season}"
            all_results[ts_key] = result
            logger.info(f"  ✓ {key}: {len(result['decision_triggers'])} triggers")
        except Exception as e:
            logger.error(f"  ✗ {key}: {e}")
    
    # Write TypeScript
    ts_code = generate_typescript(all_results)
    output_path = Path("frontend/src/data/scenarios.ts")
    output_path.parent.mkdir(parents=True, exist_ok=True)
    output_path.write_text(ts_code)
    logger.info(f"\n✓ Written: {output_path} ({len(all_results)} circuits)")


if __name__ == "__main__":
    main()
